<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digitalk - Profile</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="dark-theme">
    <div class="matrix-bg"></div>
    
    <header>
        <nav class="navbar">
            <div class="nav-brand">
                <div class="logo" onclick="window.location.href='home.html'">
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="20" cy="20" r="18" stroke="url(#gradient)" stroke-width="2" fill="rgba(0, 212, 255, 0.1)"/>
                        <path d="M12 20 L18 14 L18 17 L28 17 L28 20 L28 23 L18 23 L18 26 L12 20 Z" fill="url(#gradient)"/>
                        <circle cx="30" cy="12" r="2" fill="#00ff88"/>
                        <circle cx="30" cy="28" r="2" fill="#8b5cf6"/>
                        <defs>
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#00d4ff"/>
                                <stop offset="100%" style="stop-color:#8b5cf6"/>
                            </linearGradient>
                        </defs>
                    </svg>
                    <h1>Digitalk</h1>
                </div>
            </div>
            <div class="nav-menu">
                <a href="home.html" class="nav-link">Home</a>
                <a href="speech-to-text.html" class="nav-link">Speech to Text</a>
                <a href="text-to-speech.html" class="nav-link">Text to Speech</a>
                <a href="profile.html" class="nav-link active">Profile</a>
                <button class="nav-link logout-btn" id="logoutBtn">Logout</button>
            </div>
            <div class="nav-controls">
                <!-- Dark mode only -->
            </div>
        </nav>
    </header>

    <main class="profile-main">
        <div class="profile-header">
            <h1>Profile</h1>
            <p>Update your personal details and access all your saved conversions.</p>
        </div>

        <div class="profile-container">
            <div class="profile-info">
                <div class="user-card">
                    <div class="user-avatar">
                        <span id="userInitials">U</span>
                    </div>
                    <div class="user-details">
                        <h2 id="profileName">User Name</h2>
                        <p id="profileEmail">user@example.com</p>
                        <p class="member-since">Member since <span id="memberDate">January 2024</span></p>
                    </div>
                    <button class="btn btn-secondary" id="editProfileBtn">Edit Profile</button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalConversions">0</div>
                        <div class="stat-label">Total Conversions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="sttCount">0</div>
                        <div class="stat-label">Speech to Text</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ttsCount">0</div>
                        <div class="stat-label">Text to Speech</div>
                    </div>
                </div>
            </div>

            <div class="conversions-section">
                <div class="section-header">
                    <h2>Saved Conversions</h2>
                    <div class="filter-controls">
                        <select id="typeFilter">
                            <option value="all">All Types</option>
                            <option value="stt">Speech to Text</option>
                            <option value="tts">Text to Speech</option>
                        </select>
                        <select id="sortOrder">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                        </select>
                    </div>
                </div>

                <div class="conversions-list" id="conversionsList">
                    <div class="empty-state">
                        <div class="empty-icon">üìù</div>
                        <h3>No saved conversions yet</h3>
                        <p>Start using Speech to Text or Text to Speech features to see your saved conversions here.</p>
                        <div class="empty-actions">
                            <button class="btn btn-primary" onclick="window.location.href='speech-to-text.html'">
                                Try Speech to Text
                            </button>
                            <button class="btn btn-secondary" onclick="window.location.href='text-to-speech.html'">
                                Try Text to Speech
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Profile Modal -->
        <div class="modal" id="editProfileModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Edit Profile</h3>
                    <button class="modal-close" id="closeModal">&times;</button>
                </div>
                <form class="modal-body" id="editProfileForm">
                    <div class="form-group">
                        <label for="editName">Full Name</label>
                        <input type="text" id="editName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="editEmail">Email</label>
                        <input type="email" id="editEmail" name="email" required>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" id="cancelEdit">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Conversion Detail Modal -->
        <div class="modal" id="conversionModal">
            <div class="modal-content large">
                <div class="modal-header">
                    <h3 id="conversionModalTitle">Conversion Details</h3>
                    <button class="modal-close" id="closeConversionModal">&times;</button>
                </div>
                <div class="modal-body" id="conversionModalBody">
                    <!-- Dynamic content will be inserted here -->
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" id="deleteConversion">Delete</button>
                    <button class="btn btn-primary" id="copyConversionText">Copy Text</button>
                </div>
            </div>
        </div>

        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
    </main>

    <script src="auth.js"></script>
    <script>
        let currentConversions = [];
        let selectedConversion = null;

        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadProfileData();
            setupEventListeners();
        });

        function loadProfileData() {
            const currentUser = getCurrentUser();
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

            // Load user profile info
            document.getElementById('profileName').textContent = currentUser.name;
            document.getElementById('profileEmail').textContent = currentUser.email;
            document.getElementById('userInitials').textContent = currentUser.name.charAt(0).toUpperCase();
            
            // Set member date (using registration date if available)
            const memberDate = new Date(currentUser.registrationDate || Date.now()).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long'
            });
            document.getElementById('memberDate').textContent = memberDate;

            // Load conversions
            loadConversions();
        }

        function loadConversions() {
            const currentUser = getCurrentUser();
            if (!currentUser) return;

            currentConversions = JSON.parse(localStorage.getItem(`conversions_${currentUser.email}`)) || [];
            
            // Update stats
            updateStats();
            
            // Display conversions
            displayConversions();
        }

        function updateStats() {
            const totalConversions = currentConversions.length;
            const sttCount = currentConversions.filter(c => c.type === 'stt').length;
            const ttsCount = currentConversions.filter(c => c.type === 'tts').length;

            document.getElementById('totalConversions').textContent = totalConversions;
            document.getElementById('sttCount').textContent = sttCount;
            document.getElementById('ttsCount').textContent = ttsCount;
        }

        function displayConversions() {
            const conversionsList = document.getElementById('conversionsList');
            const typeFilter = document.getElementById('typeFilter').value;
            const sortOrder = document.getElementById('sortOrder').value;

            // Filter conversions
            let filteredConversions = currentConversions;
            if (typeFilter !== 'all') {
                filteredConversions = currentConversions.filter(c => c.type === typeFilter);
            }

            // Sort conversions
            filteredConversions.sort((a, b) => {
                return sortOrder === 'newest' ? b.timestamp - a.timestamp : a.timestamp - b.timestamp;
            });

            if (filteredConversions.length === 0) {
                conversionsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìù</div>
                        <h3>No saved conversions yet</h3>
                        <p>Start using Speech to Text or Text to Speech features to see your saved conversions here.</p>
                        <div class="empty-actions">
                            <button class="btn btn-primary" onclick="window.location.href='speech-to-text.html'">
                                Try Speech to Text
                            </button>
                            <button class="btn btn-secondary" onclick="window.location.href='text-to-speech.html'">
                                Try Text to Speech
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            conversionsList.innerHTML = filteredConversions.map(conversion => `
                <div class="conversion-item" onclick="viewConversion(${conversion.id})">
                    <div class="conversion-type">
                        ${conversion.type === 'stt' ? 'üé§' : 'üîä'}
                    </div>
                    <div class="conversion-content">
                        <div class="conversion-header">
                            <h4>${conversion.type === 'stt' ? 'Speech to Text' : 'Text to Speech'}</h4>
                            <span class="conversion-date">${formatDate(conversion.timestamp)}</span>
                        </div>
                        <p class="conversion-preview">${truncateText(conversion.text, 100)}</p>
                        <div class="conversion-meta">
                            ${conversion.type === 'stt' ? 
                                `<span>Language: ${getLanguageName(conversion.language)}</span>` :
                                `<span>Voice: ${conversion.voice}</span>`
                            }
                        </div>
                    </div>
                    <div class="conversion-actions">
                        <button class="btn-icon" onclick="event.stopPropagation(); copyText('${conversion.text}')" title="Copy">
                            üìã
                        </button>
                        <button class="btn-icon delete" onclick="event.stopPropagation(); deleteConversion(${conversion.id})" title="Delete">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function setupEventListeners() {
            // Filter and sort controls
            document.getElementById('typeFilter').addEventListener('change', displayConversions);
            document.getElementById('sortOrder').addEventListener('change', displayConversions);

            // Edit profile modal
            document.getElementById('editProfileBtn').addEventListener('click', openEditProfileModal);
            document.getElementById('closeModal').addEventListener('click', closeEditProfileModal);
            document.getElementById('cancelEdit').addEventListener('click', closeEditProfileModal);
            document.getElementById('editProfileForm').addEventListener('submit', saveProfileChanges);

            // Conversion modal
            document.getElementById('closeConversionModal').addEventListener('click', closeConversionModal);
            document.getElementById('copyConversionText').addEventListener('click', copyConversionText);
            document.getElementById('deleteConversion').addEventListener('click', deleteSelectedConversion);

            // Close modals when clicking outside
            window.addEventListener('click', function(event) {
                const editModal = document.getElementById('editProfileModal');
                const conversionModal = document.getElementById('conversionModal');
                
                if (event.target === editModal) {
                    closeEditProfileModal();
                }
                if (event.target === conversionModal) {
                    closeConversionModal();
                }
            });
        }

        function openEditProfileModal() {
            const currentUser = getCurrentUser();
            document.getElementById('editName').value = currentUser.name;
            document.getElementById('editEmail').value = currentUser.email;
            document.getElementById('editProfileModal').style.display = 'block';
        }

        function closeEditProfileModal() {
            document.getElementById('editProfileModal').style.display = 'none';
        }

        function saveProfileChanges(event) {
            event.preventDefault();
            
            const newName = document.getElementById('editName').value.trim();
            const newEmail = document.getElementById('editEmail').value.trim();
            
            if (!newName || !newEmail) {
                showError('Please fill in all fields');
                return;
            }

            const currentUser = getCurrentUser();
            const updatedUser = {
                ...currentUser,
                name: newName,
                email: newEmail
            };

            // Update user data
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const userIndex = users.findIndex(u => u.email === currentUser.email);
            if (userIndex !== -1) {
                users[userIndex] = updatedUser;
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('currentUser', JSON.stringify(updatedUser));
                
                loadProfileData();
                closeEditProfileModal();
                showSuccess('Profile updated successfully!');
            } else {
                showError('Error updating profile');
            }
        }

        function viewConversion(id) {
            selectedConversion = currentConversions.find(c => c.id === id);
            if (!selectedConversion) return;

            const modal = document.getElementById('conversionModal');
            const title = document.getElementById('conversionModalTitle');
            const body = document.getElementById('conversionModalBody');

            title.textContent = selectedConversion.type === 'stt' ? 'Speech to Text Conversion' : 'Text to Speech Conversion';
            
            body.innerHTML = `
                <div class="conversion-details">
                    <div class="detail-row">
                        <label>Date:</label>
                        <span>${formatDate(selectedConversion.timestamp)}</span>
                    </div>
                    <div class="detail-row">
                        <label>Type:</label>
                        <span>${selectedConversion.type === 'stt' ? 'Speech to Text' : 'Text to Speech'}</span>
                    </div>
                    ${selectedConversion.type === 'stt' ? `
                        <div class="detail-row">
                            <label>Language:</label>
                            <span>${getLanguageName(selectedConversion.language)}</span>
                        </div>
                        <div class="detail-row">
                            <label>Confidence:</label>
                            <span>${selectedConversion.confidence || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <label>Word Count:</label>
                            <span>${selectedConversion.wordCount || 'N/A'}</span>
                        </div>
                    ` : `
                        <div class="detail-row">
                            <label>Voice:</label>
                            <span>${selectedConversion.voice}</span>
                        </div>
                        <div class="detail-row">
                            <label>Rate:</label>
                            <span>${selectedConversion.rate}x</span>
                        </div>
                        <div class="detail-row">
                            <label>Pitch:</label>
                            <span>${selectedConversion.pitch}</span>
                        </div>
                    `}
                    <div class="detail-row full-width">
                        <label>Text:</label>
                        <div class="text-content">${selectedConversion.text}</div>
                    </div>
                </div>
            `;

            modal.style.display = 'block';
        }

        function closeConversionModal() {
            document.getElementById('conversionModal').style.display = 'none';
            selectedConversion = null;
        }

        function copyConversionText() {
            if (selectedConversion) {
                copyText(selectedConversion.text);
            }
        }

        function deleteSelectedConversion() {
            if (selectedConversion) {
                deleteConversion(selectedConversion.id);
                closeConversionModal();
            }
        }

        function deleteConversion(id) {
            if (!confirm('Are you sure you want to delete this conversion?')) {
                return;
            }

            const currentUser = getCurrentUser();
            if (!currentUser) return;

            currentConversions = currentConversions.filter(c => c.id !== id);
            localStorage.setItem(`conversions_${currentUser.email}`, JSON.stringify(currentConversions));
            
            updateStats();
            displayConversions();
            showSuccess('Conversion deleted successfully!');
        }

        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => {
                showSuccess('Text copied to clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showSuccess('Text copied to clipboard!');
            });
        }

        function formatDate(timestamp) {
            return new Date(timestamp).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function truncateText(text, maxLength) {
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        function getLanguageName(code) {
            const languages = {
                'en-US': 'English (US)',
                'en-GB': 'English (UK)',
                'es-ES': 'Spanish',
                'fr-FR': 'French',
                'de-DE': 'German',
                'it-IT': 'Italian',
                'pt-BR': 'Portuguese (Brazil)',
                'ja-JP': 'Japanese',
                'ko-KR': 'Korean',
                'zh-CN': 'Chinese (Mandarin)'
            };
            return languages[code] || code;
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>
